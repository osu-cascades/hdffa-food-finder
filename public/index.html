<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Locate the user</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />

  <script src="https://www.gstatic.com/firebasejs/7.9.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.9.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.9.2/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.9.2/firebase-storage.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #header {
      height: 60px;
      width: 100%;
      background: #222;
      color: #fff;
      position: absolute;
      ;
    }

    a {
      color: #BBE5DA;
      margin: 10px;
      position: center
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      height: calc(100% - 60px);
      margin-top: 60px;
    }
  </style>
</head>

<body>

  <!-- <div id='header' class='topnav'> -->
  <nav class="navbar navbar-inverse" role="navigation" id='header'>
    <a class='active' href='#home'>
      <img alt='Tree Root' src='design_files/images/tree-root.jpg' width="40" height="40" vspace="9"
        style="background-color:transparent"></a>
    <a href='https://hdffa.org/'>
      <img alt='HDFFA' src='https://hdffa.org/wp-content/uploads/2017/11/hdffa_color_logo2_horiz-1.png' width="100"
        height="40" vspace="9" />
    </a>
  </nav>
  <script
    src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js'></script>
  <link rel='stylesheet'
    href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css'
    type='text/css' />
  <!-- </div> -->
  <div id='map'></div>
  <script src="index.js"></script>
  <script src="config.js"></script>
  <script>
    const partnerMarkers = [];

    class SearchControl {
      onAdd(map) {
          this._map = map;
          this._container = document.createElement('div');
          this._container.className = 'mapboxgl-ctrl';
          const searchbar = document.createElement('input');
          searchbar.placeholder = "Search for partners";
          searchbar.style = "font-size: 1.5rem; font-weight: bold;"
          searchbar.oninput = (e) => {
            filterPartners(searchbar.value);
          }
          this._container.appendChild(searchbar);
          return this._container;
      }

      onRemove() {
          this._container.parentNode.removeChild(this._container);
          this._map = undefined;
      }
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoibDByZWxsZWkiLCJhIjoiY2syZ2h0YXhoMHZhdzNpdGd1c3E0azlobCJ9.KlpdomPse99D7VyPdExaLg';
    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [
        -121.260588,
        44.209118
      ], // starting position
      zoom: 9 // starting zoom
    });

    // Add geolocate control to the map.
    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true
    }));

    map.addControl(new MapboxDirections({
      accessToken: mapboxgl.accessToken
    }), 'top-left');

    map.addControl(new SearchControl(), 'bottom-left')

    function requestPartnerData() {
      var user = firebase.auth().currentUser;
      var dbPartners = firebase.database().ref().child("Partners")
          .once('value').then(function(partners) {
        console.log("Partners: ", partners);
        if(partners.exists()) {
          partners.forEach(function(partner) {
            console.log("Partner: ", partner.key)
            if(partner.val().Longitude == "" || partner.val().Latitude == "") {
            }else{
              var point = {
                "type": "Point",
                "coordinates": [
                  partner.val().Longitude,
                  partner.val().Latitude
                ],
                properties: {
                  'marker-color': '#3bb2d0',
                  'marker-size': 'large',
                  'marker-symbol': 'rocket'
                }
              }

              var popup = new mapboxgl.Popup({offset: [0, -15]})
                .setHTML('<h3 style="padding:0;margin-bottom:0;">' + 
                  partner.key + 
                  '<h3>' + partner.val().Phone);
                            
              var marker = new mapboxgl.Marker()
                .setLngLat(point.coordinates)
                .addTo(map)
                .setPopup(popup)
              partnerMarkers.push({partner: partner, marker, marker});
            }
          });
          var myLayer = L.mapbox.featureLayer().setGeoJSON(geojson).addTo(map)
        }
      })
    }

    const filterPartners = (str) => {
      console.log(str);
      filteredPartners = partnerMarkers.filter((partner) => {
        if (!partner.partner.key.toLowerCase().contains(str)) {
          return true;
        }
      });
      partnerMarkers.forEach(partner => {partner.marker.addTo(map)})
      filteredPartners.forEach(partner => { partner.marker.remove() })
    }

    window.addEvent('domready', function () {
      requestPartnerData()
    })
//Add popup
  </script>

</body>

</html>