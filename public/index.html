<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Locate the user</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #header {
      height: 60px;
      width: 100%;
      background: #222;
      color: #fff;
      position: absolute;
      ;
    }

    a {
      color: #BBE5DA;
      margin: 10px;
      position: center
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      height: calc(100% - 60px);
      margin-top: 60px;
    }
  </style>
</head>

<body>

  <!-- <div id='header' class='topnav'> -->
  <nav class="navbar navbar-inverse" role="navigation" id='header'>
    <a class='active' href='#home'>
      <img alt='Tree Root' src='design_files/images/tree-root.jpg' width="40" height="40" vspace="9"
        style="background-color:transparent"></a>
    <a href='https://hdffa.org/'>
      <img alt='HDFFA' src='https://hdffa.org/wp-content/uploads/2017/11/hdffa_color_logo2_horiz-1.png' width="100"
        height="40" vspace="9" />
    </a>
  </nav>
  <script
    src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js'></script>
  <link rel='stylesheet'
    href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css'
    type='text/css' />
  <!-- </div> -->
  <div id='map'></div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibDByZWxsZWkiLCJhIjoiY2syZ2h0YXhoMHZhdzNpdGd1c3E0azlobCJ9.KlpdomPse99D7VyPdExaLg';
    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [
        -121.260588,
        44.209118
      ], // starting position
      zoom: 9 // starting zoom
    });

    // Add geolocate control to the map.
    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true
    }));

    map.addControl(new MapboxDirections({
      accessToken: mapboxgl.accessToken
    }), 'top-left');

    // map.addControl(new MapboxGeocoder({
    // 	accessToken: mapboxgl.accessToken,
    // 	mapboxgl: mapboxgl
    // }), 'top-right');

    const geocode = (address) => {
      console.log(address);
      const request = new XMLHttpRequest();
      const url = `https://maps.googleapis.com/maps/api/geocode/json?address=` +
        address.split(" ").join("+") + "&key=AIzaSyBvX5_5aJDlyKaXc_nj0PrpkjAHrpvQLFQ";
      console.log(url);
      request.open("POST", '/partners/location');
      request.setRequestHeader('Access-Control-Allow-Origin', '*')
      request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      request.onload = () => {
        if (request.status === 200 || request.status === 201) {
          console.log(request.responseText);
          return 1;
        } else {
          console.log(request.responseText);
        }
      }
      request.send(JSON.stringify({url: url}));
    }

    function requestPartnerData() {
      var jsonRequest = new Request.JSON({
        url: 'http://localhost:3000/partners',
        onSuccess: function (geojson) {
          const data = geojson.features;
          console.log("partnerdata", data);
          for (var i = 0; i < data.length; i++) {
            var point = data[i];

            console.log("Point", point);
            var popup = new mapboxgl.Popup({ offset: [0, -15] })
              .setHTML('<h3 style="padding:0;margin-bottom:0;">' + point.properties["Farm/Business Name"] + '</h3>' +
                point.properties.phone);

            geocode(`${point.properties["Address"]}, ${point.properties["City "]}, Oregon, United States`)

            var marker = new mapboxgl.Marker()
              .setLngLat(point.geometry.coordinates)
              .addTo(map)
              .setPopup(popup);
            point.marker = marker;
          }
        }
      }).get();
    }

    window.addEvent('domready', function () {
      requestPartnerData()
    })

//Add popup
  </script>

</body>

</html>