<!-----------------Partner Post Area------------------------->
<div class="jumbotron bg-dark" style="margin-top: 15px;">
    <script>
        var counter=0;
    </script>
    <div class="container text-center">
        <form id="main-form">
            <h3 style="color: antiquewhite;">Partner Details</h3>
            <div class="form-group">
                <input id="businessName"  type="text" placeholder="Business Name" class="form-control">
            </div>
            <div class="form-group">
                <input id="firstName"  type="text" placeholder="First Name" class="form-control">
                <input id="secondName"  type="text" placeholder="Second Name" class="form-control">
            </div>
            <div class="form-wrapper">
                    <input id="phone"  type="number" placeholder="Phone" class="form-control">
                    <i class="zmdi zmdi-tablet-mac"></i>
            </div>
            <div class="form-wrapper">
                <input id="email"  type="email" placeholder="Email" class="form-control">
                <i class="zmdi zmdi-tablet-mac"></i>
            </div>
            <div class="form-wrapper">
                <input id="website"  type="url" placeholder="Website" class="form-control">
                <i class="zmdi zmdi-tablet-mac"></i>
            </div>
            <div class="form-wrapper">
                <input id="address"  type="text" placeholder="Address" class="form-control">
                <i class="zmdi zmdi-pin"></i>
            </div>
            <div class="form-wrapper">
                <select name="" id="city" class="form-control">
                    <option value="" disabled selected>City</option>
                    <option value="Bend">Bend</option>
                    <option value="Redmond">Redmond</option>
                    <option value="Sisters">Sisters</option>
                    <option value="Sunriver">Sunriver</option>
                    <option value="Culver">Culver</option>
                    <option value="La Pine">La Pine</option>
                    <option value="Prineville">Prineville</option>
                    <option value="Madras">Madras</option>
                </select> 
                <i class="zmdi zmdi-caret-down" style="font-size: 17px;"></i>
            </div>
            <div class="form-wrapper">
                <input id="state"  type="text" placeholder="State" class="form-control">
                <i class="zmdi zmdi-pin"></i>
            </div>
            <div class="form-wrapper">
                <input id="zip"  type="text" placeholder="Zip" class="form-control">
                <i class="zmdi zmdi-pin"></i>
            </div>
            <div class="form-group">
                <input id="latitude"  type="text" placeholder="Latitude" class="form-control">
                <input id="longitude"  type="text" placeholder="Longitude" class="form-control">
                <i class="zmdi zmdi-pin"></i>
            </div>
            <div class="form-wrapper">
                <input id="cat"  type="text" placeholder="Category" class="form-control">
                <i class="zmdi zmdi-account-box-mail"></i>
            </div>
            <div class="form-wrapper">
                    <input id="search"  type="url" placeholder="Search Terms" class="form-control">
                    <i class="zmdi zmdi-account-box-mail"></i>
            </div>
            <div class="form-wrapper">
                <input id="hours"  type="text" placeholder="Hours" class="form-control">
                <i class="zmdi zmdi-account-box-mail"></i>
            </div>
            <div class="form-wrapper">
                <input id="oferings"  type="text" placeholder="Farm Oferings" class="form-control">
                <i class="zmdi zmdi-account-box-mail"></i>
            </div>
            <div class="form-group">
                    <textarea type="text" rows="5" placeholder="Description..." class="form-control" id="main-desc"></textarea>
                <div class="invalid-feedback">
                        Please write some description first.
                </div>
            </div>
            <div class="form-group">
                <input type="file" class="form-control" id="main-image" />
                <div class="invalid-feedback">
                    Please choose a valid picture.
                </div>
            </div>
            <div class="form-group">
                <img id="selected-image" width="250" height="150" src="#" />
            </div>
            <div class="form-group">
                <div class="progress bg-secondary">
                    <div class="progress-bar bg-success" id="upload-progress" style="width: 0%;">0%</div>
                </div>
            </div>
            <div class="form-group">
                <button id="save-partner" type="button" style="width: 150px; height: 60px;" class="btn btn-light bg-light text-dark">Post</button>
            </div>
        </form>

        <div id="result">

        </div>

    </div>
</div>
<!-----------------Partner Post Area Ends Here------------------------->

<!-------------------After Partner Post Area------------------------->
<hr>
<br><br><br>

<div class="text-center bg-light text-dark">
    <h3>All New Partners</h3>
</div>

<hr>
<br>

<div class="row container-fluid bg-3">
    <div class="col-sm-12" id="partners">

    </div>
</div>

<br>
<!-----------------After Partner Post Area Ends Here------------------------->

<!---------------------Validation and uploading of Post Partners------------------------->
<script>
    var validImagetypes = ["image/gif", "image/jpeg", "image/png"];
    var counter=0;

    $("#selected-image").hide();

    function previewImage(image_partner)
    {
        if(image_partner.files && image_partner.files[0])
        {
            var reader = new FileReader();

            reader.onload = function(e)
            {
                $("#selected-image").attr('src', e.target.result);
                $("#selected-image").fadeIn();
            }
            reader.readAsDataURL(image_partner.files[0]);
        }
    }

    $("#main-image").change(function()
    {
        previewImage(this);
    });

    $("#save-partner").click(function()
    {
        $("#main-desc").removeClass("is-invalid");
        $("#main-image").removeClass("is-invalid");

        var desc = $("#main-desc").val();
        var phone = $("#phone").val();
        var address = $("#address").val();
        var email = $("#email").val();
        var website = $("#website").val();
        var hours = $("#hours").val();
        var fbook = $("#facebook").val();
        var profile = $("#profile").val();
        var bName = $("#businessName").val();
        var fName = $("#firstName").val();
        var sName = $("#secondName").val();
        var city = $("#city").val();
        var state = $("#state").val();
        var oferings = $("#oferings").val();
        var longitude = $("#longitude").val();
        var latitude = $("#latitude").val();
        var picture = $("#main-image").prop("files")[0];

        if(!desc)
        {
            $("#main-desc").addClass("is-invalid");
            return;
        }

        if(picture == null)
        {
            $("#main-image").addClass("is-invalid");
            return;
        }

        if($.inArray(picture["type"], validImagetypes)<0)
        {
            $("#main-image").addClass("is-invalid");
            return;
        }


        //*************************Upload and Save to Firebase Storage and Firebase Database************************
        var databaseRef = firebase.database().ref().child("Partners");

        databaseRef.once("value").then(function(snapshot)
        {
            var name = picture["name"];
            var dateStr = new Date().getTime();
            var fileCompleteName = name + "_" + dateStr;

            var storageRef = firebase.storage().ref("Partner Images");
            var partnerStorageRef = storageRef.child(fileCompleteName);

            var uploadTask = partnerStorageRef.put(picture);


            uploadTask.on("state_changed",
                
                function progress(snapshot)
                {
                    var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;

                    $("#upload-progress").html(Math.round(percentage) + "%");
                    $("#upload-progress").attr("style", "width:" + percentage + "%");    
                },
                function error(err)
                {

                },
                function complete()
                {
                    var user = firebase.auth().currentUser;
                    var userName;
                    firebase.database().ref('Users/' + user.uid).once('value').then(function(snapshot)
                    {
                        var fName = (snapshot.val() && snapshot.val().firstName);
                        var sName = (snapshot.val() && snapshot.val().secondName);

                        userName = fName + " " + sName;
                    });

                    uploadTask.snapshot.ref.getDownloadURL().then(function(downloadUrl)
                    {
                        var time = new Date();

                        var options = 
                        {
                            weekday: "long",
                            month: "long",
                            day: "2-digit",
                            year: "numeric",
                        };

                        var partnerData = 
                        {
                            "image": downloadUrl,
                            "name": fileCompleteName,
                            "desc": desc,
                            "uid": user.uid,
                            "counter": 5000 - counter,
                            "userName": userName,
                            "time": time.toLocaleString('en-US', {hour: 'numeric', minute: 'numeric', hour12: true}),
                            "date": time.toLocaleDateString('en-US', options),
                            "businessName": bName,
                            "firstName": fName,
                            "secondName": sName,
                            "address": address,
                            "city": city,
                            "state": state,
                            "longitude": longitude,
                            "latitude": latitude,
                            "phone": phone,
                            "email": email,
                            "website": website,
                            "facebook": fbook,
                            "profile": profile,
                            "hours": hours,
                            "oferings": oferings,
                        };

                        var newPartnerRef = databaseRef.child(bName);

                        newPartnerRef.set(partnerData, function(err)
                        {
                            if(err)
                            {
                                $("#result").attr("class", "alert alert-danger");
                                $("#result").html(err.message);
                            }
                            else
                            {
                                $("#result").attr("class", "alert alert-success");
                                $("#result").html("partner has been uploaded successfully.");

                                window.open("", "_self");
                            }

                            resetForm();
                        });
                    });
                }
            );
        });
    });


    function resetForm()
    {
        $("#main-form")[0].reset();
        $("#selected-image").fadeOut();
        $("#upload-progress").html("Completed");
    }


    //********************Retrieve and Display Data from Firebase**************************************
    var dbPartners = firebase.database().ref().child("Partners").orderByChild("counter");

    dbPartners.on("value", function(partners)
    {
        if(partners.exists())
        {
            var partnersHtml = "";

            partners.forEach(function(singlePartner)
            {
                counter = counter + 1;

                partnersHtml += "<div class='jumbotron bg-light text-dark border border-dark'>";
                        partnersHtml += "<div> <img width='1000px' height='550px' src='";
                            partnersHtml += singlePartner.val().image;
                        partnersHtml += "'/> </div> <br>";

                        partnersHtml += "<div class='row'>";
                            partnersHtml += "<div class='col-sm-5'> <p style='color:grey;'>"
                                         + "Published by: " + singlePartner.val().userName
                                         + "</p> </div>"  + 

                                         "<div class='col-sm-3'> <p style='color:grey;'>"
                                         + "Time: " + singlePartner.val().time
                                         + "</p> </div>"  +

                                         "<div class='col-sm-4'> <p style='color:grey; margin-left: 75px;'>"
                                         + "Date: " + singlePartner.val().date
                                         + "</p> </div>"
                                         ;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().businessName;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().firstName;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().secondName;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().address;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().city;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().state;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().latitude;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().longitude;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().phone;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().email;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().fbook;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().website;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().profile;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().hours;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().oferings;
                        partnersHtml += "</div> <br>";
                        partnersHtml += "<div style='text-align: justify; color: black;'>";
                            partnersHtml += singlePartner.val().desc;
                        partnersHtml += "</div> <br>";
                partnersHtml += "</div>";
            });
            $("#partners").html(partnersHtml);
        }
    });
    //********************Ends Here -- Retrieve and Display Data from Firebase**************************************
</script>
<!---------------------Validation and uploading of Post Partners Ends here------------------------->